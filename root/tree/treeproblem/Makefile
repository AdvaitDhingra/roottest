CLEAN_TARGETS += *.root *~ *.$(ObjSuf) *Dict.cxx *Dict.h *.$(DllSuf) reader writer Foo.so \
	 *.log $(ALL_LIBRARIES) *.exe
TEST_TARGETS +=  check Memory

ifeq ($(strip $(ROOTTEST_HOME)),)
	export ROOTTEST_HOME := $(shell expr $(PWD) : '\(.*/roottest/\)')
endif

include $(ROOTTEST_HOME)/scripts/Rules.mk

LIBS = $(ROOTLIBS)

ifeq ($(PLATFORM),macosx)
ifeq ($(MACOSX_MINOR),)
  export MACOSX_MINOR := $(shell sw_vers | sed -n 's/ProductVersion://p' | cut -d . -f 2)
endif
endif

#all:	Foo.$(DllSuf) reader$(ExeSuf) writer$(ExeSuf)
#test: check

#Foo.$(DllSuf): Foo.$(ObjSuf)
#	$(BuildFromObjs)

FooDict.cxx: Foo.h
	$(CMDECHO) rootcint -f FooDict.cxx -c Foo.h+

Foo.cxx : Foo.h

Foo.$(DllSuf): FooDict.$(ObjSuf) Foo.$(ObjSuf) Foo.h Foo.cxx
ifeq ($(ARCH),aix)
                $(CMDECHO) /usr/ibmcxx/bin/makeC++SharedLib $(OutPutOpt) $@ $(LIBS) -p 0 $^
else
ifeq ($(ARCH),aix5)
                $(CMDECHO) /usr/vacpp/bin/makeC++SharedLib $(OutPutOpt) $@ $(LIBS) -p 0 $^
else
ifeq ($(PLATFORM),macosx)
	$(CMDECHO) $(LD) $(SOFLAGS) Foo.$(ObjSuf) FooDict.$(ObjSuf) $(OutPutOpt)  $(subst .$(DllSuf),.$(LibSuf),$@)
ifneq ($(subst $(MACOSX_MINOR),,1234),1234)
# We need to make both the .dylib and the .so for 10.1-10.4
	$(CMDECHO) $(LD) -bundle -undefined  $(UNDEFOPT) -Wl,-x $(LDFLAGS)  Foo.$(ObjSuf) FooDict.$(ObjSuf)  \
                   $(OutPutOpt) $@
endif
else
ifeq ($(PLATFORM),win32)
	$(CMDECHO) bindexplib Foo Foo.$(ObjSuf) FooDict.$(ObjSuf) > Foo.def
	$(CMDECHO) lib -nologo -MACHINE:IX86  Foo.$(ObjSuf) FooDict.$(ObjSuf) -def:Foo.def \
                   $(OutPutOpt)$(subst dll,lib,$@)
	$(CMDECHO) $(LD) $(SOFLAGS) $(LDFLAGS) Foo.$(ObjSuf) FooDict.$(ObjSuf) Foo.exp $(LIBS) \
                   $(OutPutOpt)$@
else
	$(CMDECHO) $(LD) $(SOFLAGS) $(LDFLAGS) $(LIBSFORLINK) Foo.$(ObjSuf) FooDict.$(ObjSuf) $(OutPutOpt) $@
endif
endif
endif
endif

#	g++ -shared -Wl,-soname,Foo.$(DllSuf) -o Foo.$(DllSuf) Foo.$(ObjSuf) FooDict.$(ObjSuf)

reader$(ExeSuf) :reader.$(ObjSuf)
	$(CMDECHO) $(LD) reader.$(ObjSuf) $(LDFLAGS) $(LIBS) $(OutPutOpt)$@



#g++ -o $@ reader.$(ObjSuf) `root-config --libs` \
#	-Wl,-rpath,`root-config --libdir`

writer$(ExeSuf):writer.$(ObjSuf) Foo.$(DllSuf) 
	$(CMDECHO) $(LD) writer.$(ObjSuf) $(LDFLAGS) $(LIBS) Foo.$(LibSuf) $(OutPutOpt)$@

write.log:  writer$(ExeSuf) Foo.$(DllSuf)
	$(CMDECHO) root -b -l -q writer.C > write.log

reader.log: Foo.$(DllSuf) reader$(ExeSuf) write.log
	$(CMDECHO) root -b -l -q reader.C > reader.log

check: reader.log
	$(CMDECHO)diff -b -w reader.ref reader.log

Memory: Memory.log
	$(TestDiff)
